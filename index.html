<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤‡∏õ‡∏π‡∏õ‡∏•‡∏≤ PHANToM</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #020617;
    --card-bg: rgba(15,23,42,0.9);
    --accent: #22d3ee;
    --accent-soft: #0ea5e9;
    --accent-2: #a855f7;
    --border-soft: rgba(148,163,184,0.35);
    --text-main: #e5e7eb;
    --text-sub: #9ca3af;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:"Prompt",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
    background:
      radial-gradient(circle at top,#1e293b 0,#020617 40%),
      radial-gradient(circle at bottom,#0f172a 0,#020617 55%);
    color:var(--text-main);
    overflow-x:hidden;
  }
  header{
    text-align:center;
    padding:28px 16px 10px;
    animation:fadeDown 1s ease forwards;
  }
  header h1{
    margin:0;
    font-size:32px;
    letter-spacing:1.5px;
    text-shadow:0 0 18px #0ea5e9;
  }
  header p{
    margin:6px 0 0;
    color:var(--text-sub);
    font-size:14px;
  }
  .wrapper{
    max-width:1080px;
    margin:0 auto 40px;
    padding:0 16px 32px;
  }
  .tabs{
    display:flex;
    justify-content:center;
    gap:8px;
    margin:10px 0 22px;
  }
  .tab-btn{
    border-radius:999px;
    border:1px solid transparent;
    padding:8px 18px;
    font-size:14px;
    cursor:pointer;
    background:rgba(15,23,42,0.9);
    color:var(--text-sub);
    display:flex;
    align-items:center;
    gap:6px;
    transition:.2s;
  }
  .tab-btn span.icon{font-size:16px;}
  .tab-btn.active{
    border-color:var(--accent);
    color:var(--accent);
    box-shadow:0 0 16px rgba(34,211,238,0.4);
  }
  .tab-btn:hover{border-color:var(--accent-soft);}
  .panel{display:none;}
  .panel.active{display:block;}

  .card{
    background:var(--card-bg);
    border-radius:24px;
    border:1px solid var(--border-soft);
    padding:20px 16px 22px;
    box-shadow:0 18px 40px rgba(15,23,42,0.9);
    position:relative;
    overflow:hidden;
  }
  .card::before{
    content:"";
    position:absolute;
    inset:-120px;
    background:radial-gradient(circle at top,var(--accent-soft) 0,transparent 55%);
    opacity:0.08;
    pointer-events:none;
  }

  .top-row{
    display:flex;
    flex-wrap:wrap;
    gap:16px;
    align-items:flex-start;
    justify-content:center;
  }

  /* Bowl / Lid */
  .bowl-wrap{
    flex:0 1 320px;
    display:flex;
    justify-content:center;
  }
  .bowl{
    position:relative;
    width:260px;
    height:260px;
    perspective:900px;
  }
  .bowl-base{
    position:absolute;
    inset:40px 24px 12px;
    border-radius:50% 50% 40% 40%;
    background:radial-gradient(circle at 30% 15%,#1e293b 0,#020617 60%);
    box-shadow:
      0 18px 45px rgba(0,0,0,0.9),
      0 0 0 1px rgba(148,163,184,0.25);
    display:flex;
    align-items:center;
    justify-content:center;
    transform-style:preserve-3d;
    z-index:1;
    transition:opacity .25s ease;
    opacity:1;
  }
  /* ‡∏ï‡∏≠‡∏ô‡∏ù‡∏≤‡∏õ‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤‡∏´‡∏≤‡∏¢‡πÑ‡∏õ */
  .bowl.bowl--closed .bowl-base{
    opacity:0;
  }

  .bowl-lid{
    position:absolute;
    inset:8px 28px auto;
    height:120px;
    border-radius:48% 48% 42% 42%;
    background:linear-gradient(145deg,#0f172a,#1f2937);
    box-shadow:
      0 14px 30px rgba(0,0,0,0.9),
      0 0 0 1px rgba(148,163,184,0.4);
    transform-origin:center bottom;
    transform:translateY(-76px) rotateX(26deg);
    transition:transform .5s ease;
    z-index:2;
  }
  .bowl-lid::before{
    content:"";
    position:absolute;
    width:48px;
    height:14px;
    border-radius:999px 999px 8px 8px;
    background:linear-gradient(135deg,#22d3ee,#a855f7);
    top:-10px;
    left:50%;
    transform:translateX(-50%);
    box-shadow:0 0 16px rgba(34,211,238,0.7);
  }
  .bowl.bowl--closed .bowl-lid{
    transform:translateY(0) rotateX(0deg);
  }
  .bowl.bowl--shake .bowl-base,
  .bowl.bowl--shake .bowl-lid{
    animation:shake 0.6s cubic-bezier(.36,.07,.19,.97) both infinite;
  }

  .dice-row{
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:8px;
  }
  .dice-strip{display:flex;gap:8px;}
  .die{
    width:62px;
    height:62px;
    border-radius:18px;
    background:radial-gradient(circle at 25% 20%,#1f2937 0,#020617 70%);
    border:1px solid rgba(148,163,184,0.6);
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
    box-shadow:
      0 8px 18px rgba(0,0,0,0.9),
      0 0 0 1px rgba(15,23,42,0.8);
    transform:translateZ(20px);
  }
  .die-emoji{font-size:26px;}
  .die-label{
    font-size:11px;
    margin-top:3px;
    color:var(--text-sub);
  }

  .info-chip{
    font-size:11px;
    padding:4px 9px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.5);
    color:var(--text-sub);
  }

  .control-panel{
    flex:1 1 280px;
    min-width:260px;
  }
  .control-panel h2{
    margin:0 0 6px;
    font-size:20px;
  }
  .control-panel p{
    margin:0 0 10px;
    color:var(--text-sub);
    font-size:13px;
  }

  .btn-main{
    margin-top:14px;
    padding:11px 18px;
    border-radius:999px;
    border:none;
    font-size:14px;
    font-weight:600;
    cursor:pointer;
    background:linear-gradient(135deg,#22d3ee,#a855f7);
    color:#0b1120;
    display:inline-flex;
    align-items:center;
    gap:8px;
    box-shadow:0 0 20px rgba(34,211,238,0.6);
    transition:.2s;
  }
  .btn-main:hover{
    transform:translateY(-1px) scale(1.02);
    box-shadow:0 0 26px rgba(34,211,238,0.8);
  }
  .btn-main[disabled]{
    opacity:.55;
    cursor:default;
    box-shadow:none;
  }

  .small-text{
    font-size:11px;
    color:var(--text-sub);
    margin-top:6px;
  }
  .last-result{
    margin-top:10px;
    font-size:13px;
    color:var(--text-sub);
  }
  .tags{
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    margin-top:6px;
  }
  .tag{
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    background:rgba(15,23,42,0.9);
    border:1px solid rgba(148,163,184,0.3);
  }

  .history-layout{
    display:flex;
    flex-wrap:wrap;
    gap:18px;
  }
  .history-card,.stats-card{
    flex:1 1 280px;
    background:var(--card-bg);
    border-radius:20px;
    border:1px solid var(--border-soft);
    padding:14px 12px 16px;
  }
  .history-card h3,.stats-card h3{
    margin:0 0 4px;
    font-size:16px;
  }

  .history-list{
    max-height:280px;
    overflow-y:auto;
    margin-top:8px;
    padding-right:4px;
    font-size:12px;
  }
  .history-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:4px 0;
    border-bottom:1px dotted rgba(30,64,175,0.6);
  }
  .history-left{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .pill{
    padding:2px 8px;
    border-radius:999px;
    background:rgba(15,23,42,0.9);
    border:1px solid rgba(148,163,184,0.5);
    font-size:11px;
  }
  .emoji-strip{
    display:flex;
    gap:3px;
  }
  .emoji-strip span{font-size:14px;}

  .stats-grid{
    display:grid;
    grid-template-columns:1.4fr 3fr;
    gap:6px 10px;
    margin-top:10px;
    font-size:12px;
  }
  .stat-label{
    display:flex;
    align-items:center;
    gap:6px;
    color:var(--text-sub);
  }
  .stat-bar-wrap{
    background:rgba(15,23,42,0.9);
    border-radius:999px;
    overflow:hidden;
    border:1px solid rgba(30,64,175,0.7);
    height:16px;
  }
  .stat-bar{
    height:100%;
    background:linear-gradient(90deg,#22d3ee,#a855f7);
    width:0%;
    transition:width .3s ease-out;
  }
  .stat-text{
    font-size:10px;
    text-align:right;
    color:var(--text-sub);
    margin-top:2px;
  }

  .history-list::-webkit-scrollbar{width:4px;}
  .history-list::-webkit-scrollbar-thumb{
    background:#1f2937;
    border-radius:999px;
  }

  @keyframes fadeDown{
    from{opacity:0;transform:translateY(-12px);}
    to{opacity:1;transform:translateY(0);}
  }
  @keyframes shake{
    0%{transform:translate(0,0) rotate(0);}
    15%{transform:translate(-6px,-1px) rotate(-2deg);}
    30%{transform:translate(6px,1px) rotate(2deg);}
    45%{transform:translate(-5px,0) rotate(-1.5deg);}
    60%{transform:translate(4px,1px) rotate(1.5deg);}
    75%{transform:translate(-3px,-1px) rotate(-1deg);}
    100%{transform:translate(0,0) rotate(0);}
  }

  @media (max-width:640px){
    .bowl{width:220px;height:220px;}
    .bowl-base{inset:34px 20px 10px;}
    .bowl-lid{inset:6px 24px auto;height:110px;}
  }
</style>
</head>
<body>

<header>
  <h1>‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤‡∏õ‡∏π‡∏õ‡∏•‡∏≤ PHANToM</h1>
  <p>‡∏õ‡∏¥‡∏î‡∏ù‡∏≤ & ‡πÄ‡∏Ç‡∏¢‡πà‡∏≤ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ ‡∏™‡∏∏‡πà‡∏°‡πÅ‡∏ö‡∏ö Perfect Random ‚Ä¢ ‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏ú‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ô‡∏±‡πâ‡∏ô</p>
</header>

<div class="wrapper">
  <div class="tabs">
    <button class="tab-btn active" data-target="play-panel">
      <span class="icon">üé≤</span> ‡πÇ‡∏ï‡πä‡∏∞‡∏´‡∏•‡∏±‡∏Å
    </button>
    <button class="tab-btn" data-target="history-panel">
      <span class="icon">üìà</span> ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    </button>
  </div>

  <!-- ‡πÇ‡∏ï‡πä‡∏∞‡∏´‡∏•‡∏±‡∏Å -->
  <section id="play-panel" class="panel active">
    <div class="card">
      <div class="top-row">
        <div class="bowl-wrap">
          <div class="bowl bowl--open" id="bowl">
            <div class="bowl-base">
              <div class="dice-row">
                <div class="dice-strip">
                  <div class="die">
                    <div class="die-emoji" id="die1-emoji">üêü</div>
                    <div class="die-label" id="die1-label">‡∏õ‡∏•‡∏≤</div>
                  </div>
                  <div class="die">
                    <div class="die-emoji" id="die2-emoji">ü¶Ä</div>
                    <div class="die-label" id="die2-label">‡∏õ‡∏π</div>
                  </div>
                  <div class="die">
                    <div class="die-emoji" id="die3-emoji">ü¶ê</div>
                    <div class="die-label" id="die3-label">‡∏Å‡∏∏‡πâ‡∏á</div>
                  </div>
                </div>
                <span class="info-chip" id="round-info">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ñ‡∏¢‡∏ó‡∏≠‡∏¢</span>
              </div>
            </div>
            <div class="bowl-lid"></div>
          </div>
        </div>

        <div class="control-panel">
          <h2>‡∏™‡∏≠‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞: ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤‡πÄ‡∏Ç‡∏¢‡πà‡∏≤ ‚Üí ‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤‡πÇ‡∏ä‡∏ß‡πå‡∏ú‡∏•</h2>
          <p>
            ‡∏Å‡∏î‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å: ‡∏ù‡∏≤‡∏õ‡∏¥‡∏î + ‡πÄ‡∏Ç‡∏¢‡πà‡∏≤ 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î‡πÄ‡∏Ç‡∏¢‡πà‡∏≤ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏ù‡∏≤<br>
            ‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏ù‡∏≤‡∏õ‡∏¥‡∏î ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤
          </p>

          <button class="btn-main" id="shake-btn">
            <span>‡∏õ‡∏¥‡∏î‡∏ù‡∏≤ & ‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ (3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</span> <span>‚ú®</span>
          </button>

          <div class="small-text" id="mode-text">
            ‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°...
          </div>

          <div class="last-result" id="last-result">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≠‡∏¢ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏∏‡πà‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
          </div>

          <div class="tags">
            <div class="tag">3 ‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤</div>
            <div class="tag">‡∏™‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏Ç‡∏ì‡∏∞‡∏ù‡∏≤‡∏õ‡∏¥‡∏î</div>
            <div class="tag">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ 100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div>
            <div class="tag">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ realtime</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ & ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ -->
  <section id="history-panel" class="panel">
    <div class="history-layout">

      <div class="history-card">
        <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≠‡∏¢ (100 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)</h3>
        <p style="margin:0 0 4px;font-size:12px;color:var(--text-sub);">
          ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≤‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‚Üí ‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ‚Ä¢ ‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î = 1 ‡∏£‡∏≠‡∏ö‡∏ó‡∏≠‡∏¢
        </p>
        <div class="history-list" id="history-list">
          <div style="font-size:12px;color:var(--text-sub);margin-top:6px;">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡∏Å‡∏î‡∏ó‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡πÇ‡∏ï‡πä‡∏∞‡∏´‡∏•‡∏±‡∏Å‚Äù ‡∏Å‡πà‡∏≠‡∏ô
          </div>
        </div>
      </div>

      <div class="stats-card">
        <h3>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏´‡∏ô‡πâ‡∏≤ (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤)</h3>
        <p style="margin:0 0 4px;font-size:12px;color:var(--text-sub);">
          ‡∏Ñ‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏•‡∏π‡∏Å‡πÄ‡∏ï‡πã‡∏≤ ‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢ (‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 100 ‡∏£‡∏≠‡∏ö = 300 ‡∏ä‡πà‡∏≠‡∏á)
        </p>
        <div class="stats-grid" id="stats-grid"></div>
      </div>

    </div>
  </section>
</div>

<!-- Overlay Login -->
<div id="login-overlay" style="
  position:fixed;inset:0;
  display:flex;align-items:center;justify-content:center;
  background:rgba(2,6,23,0.95);z-index:9999;flex-direction:column;text-align:center;
">
  <h2 style="color:#e5e7eb;margin-bottom:10px;">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢ Google ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
  <p style="color:#9ca3af;font-size:13px;margin:0 0 14px;">
    ‡πÉ‡∏ä‡πâ Gmail ‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ ‚Ä¢ ‡πÉ‡∏ä‡πâ Firebase ‡πÄ‡∏Å‡πá‡∏ö config ‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ
  </p>
  <button id="google-login-btn" style="
    padding:10px 18px;border-radius:999px;border:0;
    background:linear-gradient(135deg,#22d3ee,#a855f7);
    color:#020617;font-weight:600;cursor:pointer;
    box-shadow:0 0 18px rgba(34,211,238,0.7);font-size:14px;
  ">
    üîë Sign in with Google
  </button>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    onAuthStateChanged
  } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
  import {
    getFirestore,
    doc,
    setDoc,
    onSnapshot,
    serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

  // üëâ ‡πÉ‡∏™‡πà config ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå Firebase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  const firebaseConfig = {
  apiKey: "AIzaSyBpxF7PVDhULJcA6LbOe8YtVmpqo77R0GQ",
  authDomain: "phantom-namtao.firebaseapp.com",
  projectId: "phantom-namtao",
  storageBucket: "phantom-namtao.firebasestorage.app",
  messagingSenderId: "842060392458",
  appId: "1:842060392458:web:e09bc5221ef8211f4957f3",
  measurementId: "G-T0BXJGRX8X"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const provider = new GoogleAuthProvider();

  const SHAKE_DURATION_MS = 3000;
  const LID_CLOSE_MS      = 400;
  const RANDOM_INTERVAL_MS= 100; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°‡∏ï‡∏≠‡∏ô‡∏ù‡∏≤‡∏õ‡∏¥‡∏î

  const animals = [
    { key:"‡∏õ‡∏•‡∏≤",    emoji:"üêü" },
    { key:"‡∏õ‡∏π",     emoji:"ü¶Ä" },
    { key:"‡∏Å‡∏∏‡πâ‡∏á",    emoji:"ü¶ê" },
    { key:"‡πÄ‡∏ï‡πà‡∏≤",   emoji:"üê¢" },
    { key:"‡πÑ‡∏Å‡πà",    emoji:"üêî" },
    { key:"‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤", emoji:"üé≤" }
  ];

  const defaultWeights = {
    "‡∏õ‡∏•‡∏≤":100,"‡∏õ‡∏π":100,"‡∏Å‡∏∏‡πâ‡∏á":100,"‡πÄ‡∏ï‡πà‡∏≤":100,"‡πÑ‡∏Å‡πà":100,"‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤":100
  };

  // global vs per-table
  let globalWeights        = { ...defaultWeights };
  let tableOverrideWeights = null;
  let useTableOverride     = false;
  let effectiveWeights     = { ...defaultWeights };

  const bowlEl       = document.getElementById("bowl");
  const shakeBtn     = document.getElementById("shake-btn");
  const roundInfo    = document.getElementById("round-info");
  const lastResultEl = document.getElementById("last-result");
  const historyList  = document.getElementById("history-list");
  const statsGrid    = document.getElementById("stats-grid");
  const modeText     = document.getElementById("mode-text");
  const loginOverlay = document.getElementById("login-overlay");
  const loginBtn     = document.getElementById("google-login-btn");

  const diceEmojiEls = [
    document.getElementById("die1-emoji"),
    document.getElementById("die2-emoji"),
    document.getElementById("die3-emoji")
  ];
  const diceLabelEls = [
    document.getElementById("die1-label"),
    document.getElementById("die2-label"),
    document.getElementById("die3-label")
  ];

  let roundCount   = 0;
  let history      = [];
  let currentUser  = null;
  let gamePhase    = "idle"; // "idle" | "closed_randomizing"
  let randomTimer  = null;
  let pendingFaces = null;

  // Tabs
  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.target).classList.add("active");
    });
  });

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á tableId ‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
  let tableId = localStorage.getItem("phantom_namtao_table_id");
  if(!tableId){
    tableId = (crypto && crypto.randomUUID) ? crypto.randomUUID() : ("table_" + Date.now());
    localStorage.setItem("phantom_namtao_table_id", tableId);
  }
  const tableDocRef  = doc(db, "tables", tableId);
  const globalDocRef = doc(db, "config", "globalGame");

  function renderDice(faces){
    faces.forEach((a,idx)=>{
      diceEmojiEls[idx].textContent = a.emoji;
      diceLabelEls[idx].textContent = a.key;
    });
  }

  function renderHistory(){
    if(history.length === 0){
      historyList.innerHTML = `<div style="font-size:12px;color:#9ca3af;margin-top:6px;">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ ‡∏Å‡∏î‡∏ó‡∏≠‡∏¢‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡πÇ‡∏ï‡πä‡∏∞‡∏´‡∏•‡∏±‡∏Å‚Äù ‡∏Å‡πà‡∏≠‡∏ô
      </div>`;
      return;
    }
    historyList.innerHTML = "";
    history.forEach(item=>{
      const row = document.createElement("div");
      row.className = "history-row";

      const left = document.createElement("div");
      left.className = "history-left";

      const roundPill = document.createElement("div");
      roundPill.className = "pill";
      roundPill.textContent = `#${item.round}`;

      const emojiStrip = document.createElement("div");
      emojiStrip.className = "emoji-strip";
      item.faces.forEach(a=>{
        const span = document.createElement("span");
        span.textContent = a.emoji;
        emojiStrip.appendChild(span);
      });

      left.appendChild(roundPill);
      left.appendChild(emojiStrip);

      const timeSpan = document.createElement("div");
      timeSpan.style.fontSize = "11px";
      timeSpan.style.color    = "#9ca3af";
      timeSpan.textContent    = item.time;

      row.appendChild(left);
      row.appendChild(timeSpan);
      historyList.appendChild(row);
    });
  }

  function renderStats(){
    statsGrid.innerHTML = "";
    if(history.length === 0){
      statsGrid.innerHTML = `<div style="grid-column:1 / -1;font-size:12px;color:#9ca3af;margin-top:6px;">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≠‡∏¢‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
      </div>`;
      return;
    }

    const counts = {};
    animals.forEach(a=>counts[a.key]=0);

    history.forEach(item=>{
      item.faces.forEach(a=>{ counts[a.key]++; });
    });

    const totalFaces = history.length * 3;

    animals.forEach(a=>{
      const count = counts[a.key];
      const pct   = totalFaces>0 ? (count/totalFaces)*100 : 0;

      const labelDiv = document.createElement("div");
      labelDiv.className = "stat-label";
      labelDiv.innerHTML = `<span>${a.emoji}</span><span>${a.key}</span>`;

      const barWrap = document.createElement("div");
      barWrap.className = "stat-bar-wrap";
      const bar = document.createElement("div");
      bar.className = "stat-bar";
      bar.style.width = pct.toFixed(1) + "%";
      barWrap.appendChild(bar);

      statsGrid.appendChild(labelDiv);
      statsGrid.appendChild(barWrap);

      const text = document.createElement("div");
      text.className = "stat-text";
      text.textContent = `${count} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‚Ä¢ ${pct.toFixed(1)}%`;
      statsGrid.appendChild(document.createElement("div"));
      statsGrid.appendChild(text);
    });
  }

  function recomputeEffectiveWeights(){
    const src = (useTableOverride && tableOverrideWeights)
      ? tableOverrideWeights
      : globalWeights;

    const merged = {...defaultWeights};
    animals.forEach(a=>{
      const raw = src[a.key];
      const v = Number(raw);
      if(!isNaN(v)){
        merged[a.key] = v;
      }
    });
    effectiveWeights = merged;
    updateModeText();
  }

  function updateModeText(){
    const srcName = useTableOverride && tableOverrideWeights
      ? "‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ (override)"
      : "Global default";

    const vals = animals.map(a=>Number(effectiveWeights[a.key] ?? 0));
    const positive = vals.filter(v=>v>0);

    if(positive.length === 0){
      modeText.textContent = `‡πÇ‡∏´‡∏°‡∏î: Fallback ‚Äì ‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤ (‡∏à‡∏≤‡∏Å ${srcName})`;
      return;
    }

    const allPos = vals.every(v=>v>0);
    if(!allPos){
      modeText.textContent = `‡πÇ‡∏´‡∏°‡∏î: Bias + Block ‚Äì ‡∏ö‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏≠‡∏≠‡∏Å‡πÄ‡∏•‡∏¢ (‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô ‚â§ 0) ‚Ä¢ ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ñ‡πà‡∏≤: ${srcName}`;
      return;
    }

    const first = vals[0];
    const allEqual = vals.every(v=>v === first);
    if(allEqual){
      modeText.textContent = `‡πÇ‡∏´‡∏°‡∏î: Perfect Random ‚Äì ‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‚Ä¢ ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ñ‡πà‡∏≤: ${srcName}`;
    }else{
      modeText.textContent = `‡πÇ‡∏´‡∏°‡∏î: Bias ‚Äì ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏°‡∏µ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÑ‡∏°‡πà‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô ‚Ä¢ ‡πÅ‡∏´‡∏•‡πà‡∏á‡∏Ñ‡πà‡∏≤: ${srcName}`;
    }
  }

  function applyGlobalConfig(data){
    if(!data || !data.weights){
      globalWeights = {...defaultWeights};
      recomputeEffectiveWeights();
      return;
    }
    const newW = {...globalWeights};
    animals.forEach(a=>{
      const v = Number(data.weights[a.key]);
      if(!isNaN(v)){
        newW[a.key] = v;
      }
    });
    globalWeights = newW;
    recomputeEffectiveWeights();
  }

  function applyTableConfig(data){
    if(!data){
      useTableOverride     = false;
      tableOverrideWeights = null;
      recomputeEffectiveWeights();
      return;
    }

    const useGlobal = data.tableUseGlobal;
    const tw        = data.tableWeights;

    if(useGlobal === true || !tw){
      useTableOverride     = false;
      tableOverrideWeights = null;
      recomputeEffectiveWeights();
      return;
    }

    const newW = {};
    animals.forEach(a=>{
      const v = Number(tw[a.key]);
      if(!isNaN(v)){
        newW[a.key] = v;
      }
    });

    tableOverrideWeights = newW;
    useTableOverride     = true;
    recomputeEffectiveWeights();
  }

  function pickOneWithWeights(){
    const keys    = animals.map(a=>a.key);
    const weights = keys.map(k=>{
      const v = Number(effectiveWeights[k] ?? 0);
      return isNaN(v) || v<0 ? 0 : v;
    });

    let total = weights.reduce((a,b)=>a+b,0);
    if(total <= 0){
      total = keys.length;
      weights.fill(1);
    }

    let r = Math.random() * total;
    for(let i=0;i<keys.length;i++){
      r -= weights[i];
      if(r <= 0) return animals[i];
    }
    return animals[animals.length-1];
  }

  function randomFaces3(){
    return [pickOneWithWeights(), pickOneWithWeights(), pickOneWithWeights()];
  }

  function startRandomization(){
    pendingFaces = randomFaces3();
    if(randomTimer) clearInterval(randomTimer);
    randomTimer = setInterval(()=>{
      pendingFaces = randomFaces3();
    }, RANDOM_INTERVAL_MS);
  }

  function stopRandomization(){
    if(randomTimer){
      clearInterval(randomTimer);
      randomTimer = null;
    }
  }

  async function recordRollToFirestore(faces){
    if(!currentUser) return;
    try{
      await setDoc(
        tableDocRef,
        {
          lastActivity: serverTimestamp(),
          lastResultKeys: faces.map(f=>f.key),
          totalRounds: roundCount,
          status: "active",
          ownerUid: currentUser.uid,
          ownerEmail: currentUser.email || null
        },
        { merge:true }
      );
    }catch(e){
      console.error("recordRollToFirestore error:", e);
    }
  }

  // Login
  loginBtn.addEventListener("click", async ()=>{
    try{
      await signInWithPopup(auth, provider);
    }catch(e){
      console.error("Google login error", e);
      alert("‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á");
    }
  });

  let firebaseReady = false;

  onAuthStateChanged(auth, async (user)=>{
    currentUser = user || null;
    if(!user){
      loginOverlay.style.display = "flex";
      return;
    }
    loginOverlay.style.display = "none";

    if(firebaseReady) return;
    firebaseReady = true;

    try{
      await setDoc(
        tableDocRef,
        {
          createdAt: serverTimestamp(),
          status: "active",
          ownerUid: user.uid,
          ownerEmail: user.email || null,
          tableUseGlobal: true // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ Global ‡∏Å‡πà‡∏≠‡∏ô
        },
        { merge:true }
      );
    }catch(e){
      console.error("init table doc error:", e);
    }

    // Global config
    onSnapshot(globalDocRef, (snap)=>{
      if(snap.exists()){
        applyGlobalConfig(snap.data());
      }else{
        globalWeights = {...defaultWeights};
        recomputeEffectiveWeights();
      }
    }, (err)=>{
      console.error("onSnapshot global config error:", err);
    });

    // Table config
    onSnapshot(tableDocRef, (snap)=>{
      if(snap.exists()){
        applyTableConfig(snap.data());
      }else{
        applyTableConfig(null);
      }
    }, (err)=>{
      console.error("onSnapshot table config error:", err);
    });
  });

  // ‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏≠‡∏á‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞
  shakeBtn.addEventListener("click", ()=>{
    if(shakeBtn.disabled) return;
    if(!currentUser){
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏î‡πâ‡∏ß‡∏¢ Google ‡∏Å‡πà‡∏≠‡∏ô");
      return;
    }

    // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ó‡∏µ‡πà 1: ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤ + ‡πÄ‡∏Ç‡∏¢‡πà‡∏≤ 3 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤
    if(gamePhase === "idle"){
      gamePhase = "closed_randomizing";

      shakeBtn.disabled = true;
      shakeBtn.innerHTML = `<span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡∏¢‡πà‡∏≤...</span> <span>üåÄ</span>`;

      // ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤
      bowlEl.classList.add("bowl--closed");
      bowlEl.classList.remove("bowl--open");

      // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏∏‡πà‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ù‡∏≤‡∏õ‡∏¥‡∏î
      startRandomization();

      // ‡∏´‡∏ô‡πà‡∏ß‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏≠‡∏ô‡∏¥‡πÄ‡∏°‡∏õ‡∏¥‡∏î‡∏ù‡∏≤ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏¢‡πà‡∏≤
      setTimeout(()=>{
        bowlEl.classList.add("bowl--shake");

        // ‡πÄ‡∏Ç‡∏¢‡πà‡∏≤ 3 ‡∏ß‡∏¥ ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏¢‡∏∏‡∏î ‡πÅ‡∏ï‡πà‡∏ù‡∏≤‡∏¢‡∏±‡∏á‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á‡∏™‡∏∏‡πà‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á
        setTimeout(()=>{
          bowlEl.classList.remove("bowl--shake");
          shakeBtn.disabled = false;
          shakeBtn.innerHTML = `<span>‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤ & ‡πÇ‡∏ä‡∏ß‡πå‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</span> <span>üëÅÔ∏è</span>`;
        }, SHAKE_DURATION_MS);
      }, LID_CLOSE_MS);

      return;
    }

    // ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏∞‡∏ó‡∏µ‡πà 2: ‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤ + ‡πÇ‡∏ä‡∏ß‡πå‡∏ú‡∏• (‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∏‡πà‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î) + ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    if(gamePhase === "closed_randomizing"){
      gamePhase = "idle";

      shakeBtn.disabled = true;
      shakeBtn.innerHTML = `<span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡∏ù‡∏≤...</span> <span>‚ú®</span>`;

      stopRandomization();
      bowlEl.classList.remove("bowl--shake");

      const faces = pendingFaces || randomFaces3();

      setTimeout(async ()=>{
        bowlEl.classList.remove("bowl--closed");
        bowlEl.classList.add("bowl--open");

        renderDice(faces);

        roundCount++;
        const now = new Date();
        const timeStr = now.toLocaleTimeString("th-TH",{hour:"2-digit",minute:"2-digit",second:"2-digit"});

        history.unshift({ round: roundCount, faces, time: timeStr });
        if(history.length > 100) history.pop();

        roundInfo.textContent = `‡∏£‡∏≠‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: #${roundCount}`;
        lastResultEl.innerHTML = `
          ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà <b>#${roundCount}</b> ‡πÄ‡∏ß‡∏•‡∏≤ ${timeStr}<br>
          ‡∏ú‡∏•: ${faces.map(f=>f.emoji + " " + f.key).join(" ‚Ä¢ ")}
        `;

        renderHistory();
        renderStats();
        await recordRollToFirestore(faces);

        // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ
        pendingFaces = randomFaces3();

        shakeBtn.disabled = false;
        shakeBtn.innerHTML = `<span>‡∏õ‡∏¥‡∏î‡∏ù‡∏≤ & ‡πÄ‡∏Ç‡∏¢‡πà‡∏≤‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ (3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</span> <span>‚ú®</span>`;
      }, 250); // ‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏ù‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏¥‡∏î
    }
  });

  // initial
  renderStats();
  recomputeEffectiveWeights();
</script>
</body>
</html>
