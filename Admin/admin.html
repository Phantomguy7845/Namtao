<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PHANToM Namtao ‚Äì Admin</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #020617;
    --card-bg: rgba(15,23,42,0.98);
    --accent: #22d3ee;
    --accent-2: #a855f7;
    --border-soft: rgba(148,163,184,0.35);
    --text-main: #e5e7eb;
    --text-sub: #9ca3af;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:"Prompt",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
    background:
      radial-gradient(circle at top,#1e293b 0,#020617 40%),
      radial-gradient(circle at bottom,#0f172a 0,#020617 55%);
    color:var(--text-main);
  }
  header{
    padding:18px 16px 8px;
    text-align:center;
  }
  header h1{
    margin:0;
    font-size:24px;
    text-shadow:0 0 16px #0ea5e9;
  }
  header p{
    margin:4px 0 0;
    font-size:13px;
    color:var(--text-sub);
  }
  .wrapper{
    max-width:1040px;
    margin:0 auto 32px;
    padding:0 16px 32px;
  }
  .card{
    background:var(--card-bg);
    border-radius:20px;
    border:1px solid var(--border-soft);
    padding:16px 14px 18px;
    margin-top:14px;
    box-shadow:0 18px 40px rgba(15,23,42,0.9);
  }
  .card h2{
    margin:0 0 6px;
    font-size:18px;
  }
  .card p{
    margin:2px 0 8px;
    font-size:13px;
    color:var(--text-sub);
  }
  .btn{
    border-radius:999px;
    border:1px solid transparent;
    padding:8px 14px;
    font-size:13px;
    cursor:pointer;
    background:linear-gradient(135deg,#22d3ee,#a855f7);
    color:#020617;
    display:inline-flex;
    align-items:center;
    gap:6px;
    box-shadow:0 0 16px rgba(34,211,238,0.5);
    margin-right:6px;
  }
  .btn-outline{
    border-color:var(--border-soft);
    background:transparent;
    color:var(--text-main);
    box-shadow:none;
  }
  .btn:disabled{
    opacity:.6;
    cursor:default;
    box-shadow:none;
  }
  .tag{
    display:inline-flex;
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid var(--border-soft);
    color:var(--text-sub);
    margin-right:6px;
  }
  .login-box{
    text-align:center;
    margin-top:12px;
  }
  .input-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    margin:4px 0;
    font-size:13px;
  }
  .input-row label{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .input-row input{
    width:90px;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid var(--border-soft);
    background:#020617;
    color:var(--text-main);
    font-size:13px;
  }
  .two-col{
    display:flex;
    flex-wrap:wrap;
    gap:16px;
  }
  .half{
    flex:1 1 260px;
  }
  .table-list{
    max-height:260px;
    overflow-y:auto;
    font-size:12px;
    margin-top:6px;
  }
  .table-row{
    border-bottom:1px solid rgba(30,64,175,0.7);
    padding:4px 0;
  }
  .table-row strong{
    font-size:12px;
  }
  .muted{
    color:var(--text-sub);
    font-size:11px;
  }
  .warn{
    color:#f97373;
    font-size:12px;
  }
</style>
</head>
<body>
<header>
  <h1>PHANToM Namtao ‚Äì Admin</h1>
  <p>‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏ú‡∏• + perfect random + ‡∏î‡∏π‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô Google ‡∏Å‡πà‡∏≠‡∏ô)</p>
</header>

<div class="wrapper">
  <div id="login-section" class="card">
    <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
    <p>‡πÉ‡∏ä‡πâ Gmail ‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ ‚Ä¢ ‡πÉ‡∏Ñ‡∏£‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ + ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à = ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏õ‡∏£‡∏±‡∏ö config</p>
    <div class="login-box">
      <button class="btn" id="login-btn">üîë Login ‡∏î‡πâ‡∏ß‡∏¢ Google</button>
      <button class="btn btn-outline" id="logout-btn" style="display:none;">üö™ Logout</button>
      <div id="login-info" class="muted" style="margin-top:8px;">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
      </div>
    </div>
  </div>

  <div id="admin-section" style="display:none;">
    <div class="card">
      <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏ô‡πâ‡∏≤</h2>
      <p>‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ‚Ä¢ doc: <code>config/globalGame</code></p>
      <div class="tag">‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô ‚Äú‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‚Äù ‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏∏‡πà‡∏°</div>

      <div class="two-col" style="margin-top:10px;">
        <div class="half">
          <div class="input-row">
            <label>üêü ‡∏õ‡∏•‡∏≤</label>
            <input type="number" id="w-fish" min="0" value="100">
          </div>
          <div class="input-row">
            <label>ü¶Ä ‡∏õ‡∏π</label>
            <input type="number" id="w-crab" min="0" value="100">
          </div>
          <div class="input-row">
            <label>ü¶ê ‡∏Å‡∏∏‡πâ‡∏á</label>
            <input type="number" id="w-shrimp" min="0" value="100">
          </div>
        </div>
        <div class="half">
          <div class="input-row">
            <label>üê¢ ‡πÄ‡∏ï‡πà‡∏≤</label>
            <input type="number" id="w-turtle" min="0" value="100">
          </div>
          <div class="input-row">
            <label>üêî ‡πÑ‡∏Å‡πà</label>
            <input type="number" id="w-chicken" min="0" value="100">
          </div>
          <div class="input-row">
            <label>üé≤ ‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤</label>
            <input type="number" id="w-gourd" min="0" value="100">
          </div>
        </div>
      </div>

      <div style="margin-top:10px;">
        <button class="btn" id="save-weights-btn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô</button>
        <button class="btn btn-outline" id="perfect-btn">üéØ Perfect Random (‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô)</button>
      </div>
      <div id="weights-status" class="muted" style="margin-top:6px;">
        ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î config ‡∏à‡∏≤‡∏Å Firestore...
      </div>
    </div>

    <div class="card">
      <h2>‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50 ‡πÇ‡∏ï‡πä‡∏∞)</h2>
      <p>‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å collection <code>tables</code> ‚Ä¢ ‡∏î‡∏π‡∏à‡∏≤‡∏Å field <code>lastActivity</code> ‡πÅ‡∏•‡∏∞ <code>totalRounds</code></p>
      <div class="table-list" id="table-list">
        <div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ï‡πä‡∏∞...</div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    onAuthStateChanged,
    signOut
  } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
  import {
    getFirestore,
    doc,
    setDoc,
    onSnapshot,
    collection,
    query,
    orderBy,
    limit,
    serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

  // üëâ ‡πÉ‡∏™‡πà config ‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå Firebase ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö index.html
  const firebaseConfig = {
  apiKey: "AIzaSyBpxF7PVDhULJcA6LbOe8YtVmpqo77R0GQ",
  authDomain: "phantom-namtao.firebaseapp.com",
  projectId: "phantom-namtao",
  storageBucket: "phantom-namtao.firebasestorage.app",
  messagingSenderId: "842060392458",
  appId: "1:842060392458:web:e09bc5221ef8211f4957f3",
  measurementId: "G-T0BXJGRX8X"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const provider = new GoogleAuthProvider();

  const loginBtn    = document.getElementById("login-btn");
  const logoutBtn   = document.getElementById("logout-btn");
  const loginInfo   = document.getElementById("login-info");
  const adminSection= document.getElementById("admin-section");
  const tableList   = document.getElementById("table-list");

  const wFish    = document.getElementById("w-fish");
  const wCrab    = document.getElementById("w-crab");
  const wShrimp  = document.getElementById("w-shrimp");
  const wTurtle  = document.getElementById("w-turtle");
  const wChicken = document.getElementById("w-chicken");
  const wGourd   = document.getElementById("w-gourd");

  const saveWeightsBtn = document.getElementById("save-weights-btn");
  const perfectBtn     = document.getElementById("perfect-btn");
  const weightsStatus  = document.getElementById("weights-status");

  const configDocRef = doc(db, "config", "globalGame");

  let currentUser = null;

  function setLoggedOutUI(){
    loginInfo.textContent   = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
    logoutBtn.style.display = "none";
    adminSection.style.display = "none";
  }

  function setLoggedInUI(user){
    loginInfo.textContent = `‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ${user.email || user.uid}`;
    logoutBtn.style.display = "inline-flex";
    adminSection.style.display = "block";
  }

  loginBtn.addEventListener("click", async ()=>{
    try{
      await signInWithPopup(auth, provider);
    }catch(e){
      console.error("login error:", e);
      loginInfo.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô: " + e.message;
    }
  });

  logoutBtn.addEventListener("click", async ()=>{
    try{
      await signOut(auth);
    }catch(e){
      console.error("logout error:", e);
    }
  });

  onAuthStateChanged(auth, user=>{
    currentUser = user || null;
    if(!user){
      setLoggedOutUI();
      return;
    }
    setLoggedInUI(user);
  });

  // sync config weights realtime
  onSnapshot(configDocRef, (snap)=>{
    if(!snap.exists()){
      weightsStatus.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ doc config/globalGame ‚Äì ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
      return;
    }
    const data    = snap.data();
    const weights = data.weights || {};

    const safe = (v, def)=> (typeof v === "number" || typeof v === "string") ? v : def;

    wFish.value    = safe(weights["‡∏õ‡∏•‡∏≤"],    100);
    wCrab.value    = safe(weights["‡∏õ‡∏π"],     100);
    wShrimp.value  = safe(weights["‡∏Å‡∏∏‡πâ‡∏á"],    100);
    wTurtle.value  = safe(weights["‡πÄ‡∏ï‡πà‡∏≤"],   100);
    wChicken.value = safe(weights["‡πÑ‡∏Å‡πà"],    100);
    wGourd.value   = safe(weights["‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤"], 100);

    weightsStatus.textContent = `‡∏≠‡πà‡∏≤‡∏ô config ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏î‡∏¢: ${data.updatedBy || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"})`;
  }, (err)=>{
    console.error("onSnapshot config error:", err);
    weightsStatus.textContent = "‡∏≠‡πà‡∏≤‡∏ô config ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message;
  });

  async function saveWeights(perfect=false){
    if(!currentUser){
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏î‡πâ‡∏ß‡∏¢ Google ‡∏Å‡πà‡∏≠‡∏ô");
      return;
    }
    const valOr = (input)=> perfect ? 100 : Number(input.value || 0);

    const payload = {
      weights: {
        "‡∏õ‡∏•‡∏≤":    valOr(wFish),
        "‡∏õ‡∏π":     valOr(wCrab),
        "‡∏Å‡∏∏‡πâ‡∏á":    valOr(wShrimp),
        "‡πÄ‡∏ï‡πà‡∏≤":   valOr(wTurtle),
        "‡πÑ‡∏Å‡πà":    valOr(wChicken),
        "‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤": valOr(wGourd)
      },
      updatedAt: serverTimestamp(),
      updatedBy: currentUser.uid
    };

    saveWeightsBtn.disabled = true;
    perfectBtn.disabled     = true;
    weightsStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÑ‡∏õ‡∏ó‡∏µ‡πà Firestore...";

    try{
      await setDoc(configDocRef, payload, { merge:true });
      weightsStatus.textContent = perfect
        ? "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: Perfect Random (‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô)"
        : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
    }catch(e){
      console.error("saveWeights error:", e);
      weightsStatus.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message;
    }finally{
      saveWeightsBtn.disabled = false;
      perfectBtn.disabled     = false;
    }
  }

  saveWeightsBtn.addEventListener("click", ()=> saveWeights(false));
  perfectBtn.addEventListener("click", ()=>{
    [wFish,wCrab,wShrimp,wTurtle,wChicken,wGourd].forEach(inp=>inp.value=100);
    saveWeights(true);
  });

  // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞
  const tablesQuery = query(
    collection(db, "tables"),
    orderBy("lastActivity", "desc"),
    limit(50)
  );

  onSnapshot(tablesQuery, (snap)=>{
    if(snap.empty){
      tableList.innerHTML = `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏¢</div>`;
      return;
    }
    const now = Date.now();
    let html = "";
    snap.forEach(docSnap=>{
      const data = docSnap.data();
      const id   = docSnap.id;

      let lastStr   = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ß‡∏•‡∏≤";
      let lastMs    = 0;
      let ownerInfo = "";

      if(data.lastActivity && data.lastActivity.toDate){
        const d = data.lastActivity.toDate();
        lastStr = d.toLocaleString("th-TH");
        lastMs  = d.getTime();
      }
      if(data.ownerEmail){
        ownerInfo = ` ‚Ä¢ owner: ${data.ownerEmail}`;
      }

      const rounds = data.totalRounds || 0;
      const status = data.status || "unknown";

      const isRecent = lastMs && ((now - lastMs) < 15*60*1000);

      html += `
        <div class="table-row">
          <strong>${id}</strong><br>
          <span class="muted">
            lastActivity: ${lastStr} ‚Ä¢ ‡∏£‡∏≠‡∏ö‡πÄ‡∏•‡πà‡∏ô: ${rounds} ‚Ä¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status}
            ${isRecent ? " ‚Ä¢ üü¢ active" : " ‚Ä¢ ‚ö™ idle"}
            ${ownerInfo}
          </span>
        </div>
      `;
    });
    tableList.innerHTML = html;
  }, (err)=>{
    console.error("tables snapshot error:", err);
    tableList.innerHTML = `<div class="warn">‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</div>`;
  });
</script>
</body>
</html>
