<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PHANToM Namtao ‚Äì Admin</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg: #020617;
    --card-bg: rgba(15,23,42,0.98);
    --accent: #22d3ee;
    --accent-2: #a855f7;
    --border-soft: rgba(148,163,184,0.35);
    --text-main: #e5e7eb;
    --text-sub: #9ca3af;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:"Prompt",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
    background:
      radial-gradient(circle at top,#1e293b 0,#020617 40%),
      radial-gradient(circle at bottom,#0f172a 0,#020617 55%);
    color:var(--text-main);
  }
  header{
    padding:18px 16px 8px;
    text-align:center;
  }
  header h1{
    margin:0;
    font-size:24px;
    text-shadow:0 0 16px #0ea5e9;
  }
  header p{
    margin:4px 0 0;
    font-size:13px;
    color:var(--text-sub);
  }
  .wrapper{
    max-width:1040px;
    margin:0 auto 32px;
    padding:0 16px 32px;
  }
  .card{
    background:var(--card-bg);
    border-radius:20px;
    border:1px solid var(--border-soft);
    padding:16px 14px 18px;
    margin-top:14px;
    box-shadow:0 18px 40px rgba(15,23,42,0.9);
  }
  .card h2{
    margin:0 0 6px;
    font-size:18px;
  }
  .card p{
    margin:2px 0 8px;
    font-size:13px;
    color:var(--text-sub);
  }
  .btn{
    border-radius:999px;
    border:1px solid transparent;
    padding:8px 14px;
    font-size:13px;
    cursor:pointer;
    background:linear-gradient(135deg,#22d3ee,#a855f7);
    color:#020617;
    display:inline-flex;
    align-items:center;
    gap:6px;
    box-shadow:0 0 16px rgba(34,211,238,0.5);
    margin-right:6px;
  }
  .btn-outline{
    border-color:var(--border-soft);
    background:transparent;
    color:var(--text-main);
    box-shadow:none;
  }
  .btn:disabled{
    opacity:.6;
    cursor:default;
    box-shadow:none;
  }
  .tag{
    display:inline-flex;
    font-size:11px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid var(--border-soft);
    color:var(--text-sub);
    margin-right:6px;
  }
  .login-box{
    text-align:center;
    margin-top:12px;
  }
  .two-col{
    display:flex;
    flex-wrap:wrap;
    gap:16px;
  }
  .half{
    flex:1 1 260px;
  }
  .input-row{
    display:flex;
    align-items:center;
    gap:8px;
    margin:6px 0;
    font-size:13px;
  }
  .input-row label{
    min-width:70px;
    display:flex;
    align-items:center;
    gap:6px;
  }
  .input-row input[type="range"]{
    flex:1;
    accent-color:var(--accent);
  }
  .range-display{
    width:46px;
    text-align:right;
    font-size:12px;
    color:var(--text-sub);
  }
  .muted{
    color:var(--text-sub);
    font-size:11px;
  }
  .warn{
    color:#f97373;
    font-size:12px;
  }
  select{
    border-radius:999px;
    border:1px solid var(--border-soft);
    background:#020617;
    color:var(--text-main);
    padding:4px 10px;
    font-size:12px;
    max-width:100%;
  }
  .table-list{
    max-height:260px;
    overflow-y:auto;
    font-size:12px;
    margin-top:6px;
  }
  .table-row{
    border-bottom:1px solid rgba(30,64,175,0.7);
    padding:4px 0;
  }
  .table-row strong{
    font-size:12px;
  }
  .filter-row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    margin:4px 0 8px;
    font-size:12px;
  }
  .filter-row input[type="text"]{
    border-radius:999px;
    border:1px solid var(--border-soft);
    background:#020617;
    color:var(--text-main);
    padding:4px 10px;
    font-size:12px;
    min-width:220px;
  }
  .filter-row label{
    display:flex;
    align-items:center;
    gap:4px;
    color:var(--text-sub);
  }
</style>
</head>
<body>
<header>
  <h1>PHANToM Namtao ‚Äì Admin</h1>
  <p>‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏≠‡∏≠‡∏Å‡∏ú‡∏•‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ö‡∏ö Global ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏ï‡πä‡∏∞ ‚Ä¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏î‡πâ‡∏ß‡∏¢ Gmail owner + filter active</p>
</header>

<div class="wrapper">
  <div class="card">
    <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h2>
    <p>‡πÉ‡∏ä‡πâ Gmail ‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ ‚Ä¢ ‡πÉ‡∏Ñ‡∏£‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ + ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à = ‡πÅ‡∏Å‡πâ config ‡πÑ‡∏î‡πâ</p>
    <div class="login-box">
      <button class="btn" id="login-btn">üîë Login ‡∏î‡πâ‡∏ß‡∏¢ Google</button>
      <button class="btn btn-outline" id="logout-btn" style="display:none;">üö™ Logout</button>
      <div id="login-info" class="muted" style="margin-top:8px;">
        ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
      </div>
    </div>
  </div>

  <!-- Global default -->
  <div id="global-section" class="card" style="display:none;">
    <h2>Global default ‚Äì ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏≠‡∏á</h2>
    <p>doc: <code>config/globalGame</code> ‚Ä¢ ‡∏ñ‡πâ‡∏≤‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ override ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ</p>
    <div class="tag">‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÇ‡∏ï‡πä‡∏∞</div>

    <div class="two-col" style="margin-top:10px;">
      <div class="half">
        <div class="input-row">
          <label>üêü ‡∏õ‡∏•‡∏≤</label>
          <input type="range" id="g-fish" min="0" max="200" step="1" value="100">
          <span class="range-display" id="g-fish-val">100</span>
        </div>
        <div class="input-row">
          <label>ü¶Ä ‡∏õ‡∏π</label>
          <input type="range" id="g-crab" min="0" max="200" step="1" value="100">
          <span class="range-display" id="g-crab-val">100</span>
        </div>
        <div class="input-row">
          <label>ü¶ê ‡∏Å‡∏∏‡πâ‡∏á</label>
          <input type="range" id="g-shrimp" min="0" max="200" step="1" value="100">
          <span class="range-display" id="g-shrimp-val">100</span>
        </div>
      </div>
      <div class="half">
        <div class="input-row">
          <label>üê¢ ‡πÄ‡∏ï‡πà‡∏≤</label>
          <input type="range" id="g-turtle" min="0" max="200" step="1" value="100">
          <span class="range-display" id="g-turtle-val">100</span>
        </div>
        <div class="input-row">
          <label>üêî ‡πÑ‡∏Å‡πà</label>
          <input type="range" id="g-chicken" min="0" max="200" step="1" value="100">
          <span class="range-display" id="g-chicken-val">100</span>
        </div>
        <div class="input-row">
          <label>üé≤ ‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤</label>
          <input type="range" id="g-gourd" min="0" max="200" step="1" value="100">
          <span class="range-display" id="g-gourd-val">100</span>
        </div>
      </div>
    </div>

    <div style="margin-top:10px;">
      <button class="btn" id="save-global-btn">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Global</button>
      <button class="btn btn-outline" id="perfect-global-btn">üéØ Perfect Random (‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô)</button>
    </div>
    <div id="global-status" class="muted" style="margin-top:6px;">
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î config ‡∏à‡∏≤‡∏Å Firestore...
    </div>
  </div>

  <!-- Per-table override -->
  <div id="table-config-section" class="card" style="display:none;">
    <h2>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏ï‡πä‡∏∞ (Per-table override)</h2>
    <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡πâ‡∏ß‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏±‡πâ‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÇ‡∏ï‡πä‡∏∞‡∏≠‡∏∑‡πà‡∏ô</p>

    <div class="filter-row">
      <span class="muted">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞:</span>
      <select id="table-select">
        <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ ‚Äî</option>
      </select>

      <input type="text" id="owner-filter" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å Gmail owner ‡πÄ‡∏ä‡πà‡∏ô name@gmail.com" />

      <label>
        <input type="checkbox" id="active-only" />
        ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà active ‡∏≠‡∏¢‡∏π‡πà
      </label>
    </div>

    <div id="table-meta" class="muted" style="margin-bottom:8px;">
      ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞
    </div>

    <div class="two-col">
      <div class="half">
        <div class="input-row">
          <label>üêü ‡∏õ‡∏•‡∏≤</label>
          <input type="range" id="t-fish" min="0" max="200" step="1" value="100" disabled>
          <span class="range-display" id="t-fish-val">100</span>
        </div>
        <div class="input-row">
          <label>ü¶Ä ‡∏õ‡∏π</label>
          <input type="range" id="t-crab" min="0" max="200" step="1" value="100" disabled>
          <span class="range-display" id="t-crab-val">100</span>
        </div>
        <div class="input-row">
          <label>ü¶ê ‡∏Å‡∏∏‡πâ‡∏á</label>
          <input type="range" id="t-shrimp" min="0" max="200" step="1" value="100" disabled>
          <span class="range-display" id="t-shrimp-val">100</span>
        </div>
      </div>
      <div class="half">
        <div class="input-row">
          <label>üê¢ ‡πÄ‡∏ï‡πà‡∏≤</label>
          <input type="range" id="t-turtle" min="0" max="200" step="1" value="100" disabled>
          <span class="range-display" id="t-turtle-val">100</span>
        </div>
        <div class="input-row">
          <label>üêî ‡πÑ‡∏Å‡πà</label>
          <input type="range" id="t-chicken" min="0" max="200" step="1" value="100" disabled>
          <span class="range-display" id="t-chicken-val">100</span>
        </div>
        <div class="input-row">
          <label>üé≤ ‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤</label>
          <input type="range" id="t-gourd" min="0" max="200" step="1" value="100" disabled>
          <span class="range-display" id="t-gourd-val">100</span>
        </div>
      </div>
    </div>

    <div style="margin-top:10px;">
      <button class="btn" id="save-table-btn" disabled>üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ</button>
      <button class="btn btn-outline" id="perfect-table-btn" disabled>üéØ Perfect Random ‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ</button>
      <button class="btn btn-outline" id="use-global-btn" disabled>‚Ü© ‡πÉ‡∏ä‡πâ Global default</button>
    </div>
    <div id="table-status" class="muted" style="margin-top:6px;">
      ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
    </div>
  </div>

  <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞ -->
  <div id="tables-section" class="card" style="display:none;">
    <h2>‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏¢‡∏π‡πà (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50 ‡πÇ‡∏ï‡πä‡∏∞)</h2>
    <p>‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å collection <code>tables</code> ‚Ä¢ ‡πÉ‡∏ä‡πâ filter ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏≤‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£</p>
    <div class="filter-row">
      <span class="muted">Filter ‡∏ã‡πâ‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢):</span>
      <input type="text" id="owner-filter-list" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å Gmail owner" />
      <label>
        <input type="checkbox" id="active-only-list" />
        ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ active
      </label>
    </div>
    <div class="table-list" id="table-list">
      <div class="muted">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏ï‡πä‡∏∞...</div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js';
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    onAuthStateChanged,
    signOut
  } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js';
  import {
    getFirestore,
    doc,
    setDoc,
    onSnapshot,
    collection,
    query,
    orderBy,
    limit,
    serverTimestamp
  } from 'https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js';

  // üëâ ‡πÉ‡∏ä‡πâ config ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö index.html
  const firebaseConfig = {
  apiKey: "AIzaSyBpxF7PVDhULJcA6LbOe8YtVmpqo77R0GQ",
  authDomain: "phantom-namtao.firebaseapp.com",
  projectId: "phantom-namtao",
  storageBucket: "phantom-namtao.firebasestorage.app",
  messagingSenderId: "842060392458",
  appId: "1:842060392458:web:e09bc5221ef8211f4957f3",
  measurementId: "G-T0BXJGRX8X"
  };

  const app  = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const provider = new GoogleAuthProvider();

  const loginBtn      = document.getElementById("login-btn");
  const logoutBtn     = document.getElementById("logout-btn");
  const loginInfo     = document.getElementById("login-info");
  const globalSection = document.getElementById("global-section");
  const tableCfgSection = document.getElementById("table-config-section");
  const tablesSection = document.getElementById("tables-section");

  // Global inputs
  const gFish    = document.getElementById("g-fish");
  const gCrab    = document.getElementById("g-crab");
  const gShrimp  = document.getElementById("g-shrimp");
  const gTurtle  = document.getElementById("g-turtle");
  const gChicken = document.getElementById("g-chicken");
  const gGourd   = document.getElementById("g-gourd");
  const gFishVal    = document.getElementById("g-fish-val");
  const gCrabVal    = document.getElementById("g-crab-val");
  const gShrimpVal  = document.getElementById("g-shrimp-val");
  const gTurtleVal  = document.getElementById("g-turtle-val");
  const gChickenVal = document.getElementById("g-chicken-val");
  const gGourdVal   = document.getElementById("g-gourd-val");

  const saveGlobalBtn    = document.getElementById("save-global-btn");
  const perfectGlobalBtn = document.getElementById("perfect-global-btn");
  const globalStatus     = document.getElementById("global-status");

  // Per-table inputs
  const tableSelect   = document.getElementById("table-select");
  const ownerFilter   = document.getElementById("owner-filter");
  const activeOnlyChk = document.getElementById("active-only");

  const tFish   = document.getElementById("t-fish");
  const tCrab   = document.getElementById("t-crab");
  const tShrimp = document.getElementById("t-shrimp");
  const tTurtle = document.getElementById("t-turtle");
  const tChicken= document.getElementById("t-chicken");
  const tGourd  = document.getElementById("t-gourd");
  const tFishVal   = document.getElementById("t-fish-val");
  const tCrabVal   = document.getElementById("t-crab-val");
  const tShrimpVal = document.getElementById("t-shrimp-val");
  const tTurtleVal = document.getElementById("t-turtle-val");
  const tChickenVal= document.getElementById("t-chicken-val");
  const tGourdVal  = document.getElementById("t-gourd-val");

  const saveTableBtn    = document.getElementById("save-table-btn");
  const perfectTableBtn = document.getElementById("perfect-table-btn");
  const useGlobalBtn    = document.getElementById("use-global-btn");
  const tableStatus     = document.getElementById("table-status");
  const tableMeta       = document.getElementById("table-meta");

  // Table list filter
  const ownerFilterList = document.getElementById("owner-filter-list");
  const activeOnlyList  = document.getElementById("active-only-list");
  const tableList       = document.getElementById("table-list");

  const globalDocRef = doc(db,"config","globalGame");

  let currentUser   = null;
  let globalWeightsCache = {
    "‡∏õ‡∏•‡∏≤":100,"‡∏õ‡∏π":100,"‡∏Å‡∏∏‡πâ‡∏á":100,"‡πÄ‡∏ï‡πà‡∏≤":100,"‡πÑ‡∏Å‡πà":100,"‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤":100
  };

  let tablesArray   = []; // [{id,data,lastMs,isRecent,owner,rounds,status,hasOverride}]
  let tablesCache   = {}; // id -> data
  let currentTableId = null;

  function setLoggedOutUI(){
    loginInfo.textContent   = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
    logoutBtn.style.display = "none";
    globalSection.style.display = "none";
    tableCfgSection.style.display = "none";
    tablesSection.style.display   = "none";
  }

  function setLoggedInUI(user){
    loginInfo.textContent = `‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏õ‡πá‡∏ô: ${user.email || user.uid}`;
    logoutBtn.style.display = "inline-flex";
    globalSection.style.display = "block";
    tableCfgSection.style.display = "block";
    tablesSection.style.display   = "block";
  }

  loginBtn.addEventListener("click", async ()=>{
    try{
      await signInWithPopup(auth, provider);
    }catch(e){
      console.error("login error:", e);
      loginInfo.textContent = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô: " + e.message;
    }
  });

  logoutBtn.addEventListener("click", async ()=>{
    try{
      await signOut(auth);
    }catch(e){
      console.error("logout error:", e);
    }
  });

  onAuthStateChanged(auth, user=>{
    currentUser = user || null;
    if(!user){
      setLoggedOutUI();
      return;
    }
    setLoggedInUI(user);
  });

  // Utility: range display binding
  function bindRangeWithDisplay(inputEl, displayEl){
    const refresh = ()=>{ displayEl.textContent = inputEl.value; };
    inputEl.addEventListener("input", refresh);
    refresh();
  }

  [ [gFish,gFishVal], [gCrab,gCrabVal], [gShrimp,gShrimpVal],
    [gTurtle,gTurtleVal], [gChicken,gChickenVal], [gGourd,gGourdVal],
    [tFish,tFishVal], [tCrab,tCrabVal], [tShrimp,tShrimpVal],
    [tTurtle,tTurtleVal], [tChicken,tChickenVal], [tGourd,tGourdVal]
  ].forEach(([i,d])=> bindRangeWithDisplay(i,d));

  // --- Global config realtime ---
  onSnapshot(globalDocRef, (snap)=>{
    if(!snap.exists()){
      globalStatus.textContent = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ doc config/globalGame ‚Äì ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å";
      return;
    }
    const data    = snap.data();
    const weights = data.weights || {};

    const safe = (v, def)=> (typeof v === "number" || typeof v === "string") ? v : def;

    gFish.value    = safe(weights["‡∏õ‡∏•‡∏≤"],    100);
    gCrab.value    = safe(weights["‡∏õ‡∏π"],     100);
    gShrimp.value  = safe(weights["‡∏Å‡∏∏‡πâ‡∏á"],    100);
    gTurtle.value  = safe(weights["‡πÄ‡∏ï‡πà‡∏≤"],   100);
    gChicken.value = safe(weights["‡πÑ‡∏Å‡πà"],    100);
    gGourd.value   = safe(weights["‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤"], 100);

    [ [gFish,gFishVal], [gCrab,gCrabVal], [gShrimp,gShrimpVal],
      [gTurtle,gTurtleVal], [gChicken,gChickenVal], [gGourd,gGourdVal]
    ].forEach(([i,d])=>{ d.textContent = i.value; });

    globalWeightsCache = {
      "‡∏õ‡∏•‡∏≤":   Number(gFish.value),
      "‡∏õ‡∏π":    Number(gCrab.value),
      "‡∏Å‡∏∏‡πâ‡∏á":   Number(gShrimp.value),
      "‡πÄ‡∏ï‡πà‡∏≤":  Number(gTurtle.value),
      "‡πÑ‡∏Å‡πà":   Number(gChicken.value),
      "‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤": Number(gGourd.value)
    };

    globalStatus.textContent = `‡∏≠‡πà‡∏≤‡∏ô Global config ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß (‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÇ‡∏î‡∏¢: ${data.updatedBy || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"})`;
  }, (err)=>{
    console.error("onSnapshot global error:", err);
    globalStatus.textContent = "‡∏≠‡πà‡∏≤‡∏ô Global config ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message;
  });

  async function saveGlobal(perfect=false){
    if(!currentUser){
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô");
      return;
    }
    const valOr = (input)=> perfect ? 100 : Number(input.value || 0);

    const payload = {
      weights:{
        "‡∏õ‡∏•‡∏≤":    valOr(gFish),
        "‡∏õ‡∏π":     valOr(gCrab),
        "‡∏Å‡∏∏‡πâ‡∏á":    valOr(gShrimp),
        "‡πÄ‡∏ï‡πà‡∏≤":   valOr(gTurtle),
        "‡πÑ‡∏Å‡πà":    valOr(gChicken),
        "‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤": valOr(gGourd)
      },
      updatedAt: serverTimestamp(),
      updatedBy: currentUser.uid
    };

    saveGlobalBtn.disabled    = true;
    perfectGlobalBtn.disabled = true;
    globalStatus.textContent  = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Global config ...";

    try{
      await setDoc(globalDocRef, payload, {merge:true});
      globalStatus.textContent = perfect
        ? "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: Global Perfect Random (‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô)"
        : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: Global config ‡∏ñ‡∏π‡∏Å‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï";
    }catch(e){
      console.error("saveGlobal error:", e);
      globalStatus.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Global ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message;
    }finally{
      saveGlobalBtn.disabled    = false;
      perfectGlobalBtn.disabled = false;
    }
  }

  saveGlobalBtn.addEventListener("click", ()=> saveGlobal(false));
  perfectGlobalBtn.addEventListener("click", ()=>{
    [gFish,gCrab,gShrimp,gTurtle,gChicken,gGourd].forEach(inp=>inp.value=100);
    [ [gFish,gFishVal], [gCrab,gCrabVal], [gShrimp,gShrimpVal],
      [gTurtle,gTurtleVal], [gChicken,gChickenVal], [gGourd,gGourdVal]
    ].forEach(([i,d])=>{ d.textContent = i.value; });
    saveGlobal(true);
  });

  // --- Per-table override ---
  function setTableInputsEnabled(enabled){
    const inputs = [tFish,tCrab,tShrimp,tTurtle,tChicken,tGourd];
    inputs.forEach(i=>{ i.disabled = !enabled; });
    saveTableBtn.disabled    = !enabled;
    perfectTableBtn.disabled = !enabled;
    useGlobalBtn.disabled    = !enabled;
  }

  function loadTableConfigToInputs(tableId){
    if(!tableId || !tablesCache[tableId]){
      tableMeta.textContent   = "‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞";
      tableStatus.textContent = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞‡∏à‡∏≤‡∏Å dropdown ‡∏Å‡πà‡∏≠‡∏ô";
      setTableInputsEnabled(false);
      return;
    }
    const data = tablesCache[tableId];

    const owner = data.ownerEmail || data.ownerUid || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
    const override = data.tableWeights && data.tableUseGlobal === false;

    tableMeta.textContent = `‡πÇ‡∏ï‡πä‡∏∞: ${tableId} ‚Ä¢ owner: ${owner} ‚Ä¢ mode: ${override ? "‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏ï‡πä‡∏∞" : "‡πÉ‡∏ä‡πâ Global default"}`;

    if(override){
      const tw = data.tableWeights || {};
      const safe = (v,def)=> (typeof v==="number"||typeof v==="string")?v:def;
      tFish.value    = safe(tw["‡∏õ‡∏•‡∏≤"],    globalWeightsCache["‡∏õ‡∏•‡∏≤"]);
      tCrab.value    = safe(tw["‡∏õ‡∏π"],     globalWeightsCache["‡∏õ‡∏π"]);
      tShrimp.value  = safe(tw["‡∏Å‡∏∏‡πâ‡∏á"],    globalWeightsCache["‡∏Å‡∏∏‡πâ‡∏á"]);
      tTurtle.value  = safe(tw["‡πÄ‡∏ï‡πà‡∏≤"],   globalWeightsCache["‡πÄ‡∏ï‡πà‡∏≤"]);
      tChicken.value = safe(tw["‡πÑ‡∏Å‡πà"],    globalWeightsCache["‡πÑ‡∏Å‡πà"]);
      tGourd.value   = safe(tw["‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤"], globalWeightsCache["‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤"]);
      tableStatus.textContent = "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ override ‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà";
    }else{
      tFish.value    = globalWeightsCache["‡∏õ‡∏•‡∏≤"];
      tCrab.value    = globalWeightsCache["‡∏õ‡∏π"];
      tShrimp.value  = globalWeightsCache["‡∏Å‡∏∏‡πâ‡∏á"];
      tTurtle.value  = globalWeightsCache["‡πÄ‡∏ï‡πà‡∏≤"];
      tChicken.value = globalWeightsCache["‡πÑ‡∏Å‡πà"];
      tGourd.value   = globalWeightsCache["‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤"];
      tableStatus.textContent = "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ Global default ‚Ä¢ ‡∏´‡∏≤‡∏Å‡∏Å‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á override ‡πÉ‡∏´‡∏°‡πà";
    }

    [ [tFish,tFishVal],[tCrab,tCrabVal],[tShrimp,tShrimpVal],
      [tTurtle,tTurtleVal],[tChicken,tChickenVal],[tGourd,tGourdVal]
    ].forEach(([i,d])=>{ d.textContent = i.value; });

    setTableInputsEnabled(true);
  }

  async function saveTableOverride(perfect=false){
    if(!currentUser){
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô");
      return;
    }
    if(!currentTableId){
      alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞");
      return;
    }
    const valOr = (input)=> perfect ? 100 : Number(input.value || 0);

    const payload = {
      tableUseGlobal: false,
      tableWeights: {
        "‡∏õ‡∏•‡∏≤":    valOr(tFish),
        "‡∏õ‡∏π":     valOr(tCrab),
        "‡∏Å‡∏∏‡πâ‡∏á":    valOr(tShrimp),
        "‡πÄ‡∏ï‡πà‡∏≤":   valOr(tTurtle),
        "‡πÑ‡∏Å‡πà":    valOr(tChicken),
        "‡∏ô‡πâ‡∏≥‡πÄ‡∏ï‡πâ‡∏≤": valOr(tGourd)
      },
      tableConfigUpdatedAt: serverTimestamp(),
      tableConfigUpdatedBy: currentUser.uid
    };

    const ref = doc(db,"tables",currentTableId);
    setTableInputsEnabled(false);
    tableStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ...";

    try{
      await setDoc(ref, payload, {merge:true});
      tableStatus.textContent = perfect
        ? "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Perfect Random (override)"
        : "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ override ‡πÉ‡∏´‡∏°‡πà";
    }catch(e){
      console.error("saveTableOverride error:", e);
      tableStatus.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message;
    }finally{
      setTableInputsEnabled(true);
    }
  }

  async function useGlobalForTable(){
    if(!currentUser){
      alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô");
      return;
    }
    if(!currentTableId){
      alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞");
      return;
    }
    const ref = doc(db,"tables",currentTableId);
    setTableInputsEnabled(false);
    tableStatus.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏ä‡πâ Global...";

    try{
      await setDoc(ref,{
        tableUseGlobal:true,
        tableWeights:null,
        tableConfigUpdatedAt: serverTimestamp(),
        tableConfigUpdatedBy: currentUser.uid
      },{merge:true});
      tableStatus.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: ‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÉ‡∏ä‡πâ Global default";
    }catch(e){
      console.error("useGlobalForTable error:", e);
      tableStatus.textContent = "‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Global ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message;
    }finally{
      setTableInputsEnabled(true);
    }
  }

  saveTableBtn.addEventListener("click", ()=> saveTableOverride(false));
  perfectTableBtn.addEventListener("click", ()=>{
    [tFish,tCrab,tShrimp,tTurtle,tChicken,tGourd].forEach(inp=>inp.value=100);
    [ [tFish,tFishVal],[tCrab,tCrabVal],[tShrimp,tShrimpVal],
      [tTurtle,tTurtleVal],[tChicken,tChickenVal],[tGourd,tGourdVal]
    ].forEach(([i,d])=>{ d.textContent = i.value; });
    saveTableOverride(true);
  });
  useGlobalBtn.addEventListener("click", useGlobalForTable);

  tableSelect.addEventListener("change", ()=>{
    currentTableId = tableSelect.value || null;
    loadTableConfigToInputs(currentTableId);
  });

  // --- Filter & render tables (‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á dropdown ‡πÅ‡∏•‡∏∞ list) ---
  function applyFiltersAndRender(){
    const now = Date.now();
    const ownerFilterText   = (ownerFilter.value || "").toLowerCase();
    const ownerFilterListTx = (ownerFilterList.value || "").toLowerCase();
    const ownerFilterMerged = (ownerFilterText || ownerFilterListTx);
    const activeOnlyMain    = activeOnlyChk.checked;
    const activeOnlyListVal = activeOnlyList.checked;

    let filtered = tablesArray.slice();

    if(ownerFilterMerged){
      filtered = filtered.filter(t => {
        const email = (t.owner || "").toLowerCase();
        return email.includes(ownerFilterMerged);
      });
    }

    if(activeOnlyMain || activeOnlyListVal){
      filtered = filtered.filter(t => t.isRecent);
    }

    // render dropdown
    let optsHtml = `<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ ‚Äî</option>`;
    filtered.forEach(t=>{
      const label = `${t.id.substring(0,8)}‚Ä¶ ‚Ä¢ ${t.configLabel} ‚Ä¢ ‡∏£‡∏≠‡∏ö ${t.rounds}`;
      optsHtml += `<option value="${t.id}">${label}</option>`;
    });
    tableSelect.innerHTML = optsHtml;

    if(currentTableId && filtered.some(t=>t.id===currentTableId)){
      tableSelect.value = currentTableId;
    }else{
      currentTableId = "";
      loadTableConfigToInputs(null);
    }

    // render list
    if(filtered.length === 0){
      tableList.innerHTML = `<div class="muted">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ï‡πä‡∏∞‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>`;
      return;
    }

    let listHtml = "";
    filtered.forEach(t=>{
      const statusEmoji = t.isRecent ? "üü¢ active" : "‚ö™ idle";
      listHtml += `
        <div class="table-row">
          <strong>${t.id}</strong><br>
          <span class="muted">
            lastActivity: ${t.lastStr} ‚Ä¢ ‡∏£‡∏≠‡∏ö‡πÄ‡∏•‡πà‡∏ô: ${t.rounds} ‚Ä¢ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${t.status}
            ‚Ä¢ ${statusEmoji}
            ‚Ä¢ owner: ${t.owner}
            ‚Ä¢ config: ${t.configLabel}
          </span>
        </div>
      `;
    });
    tableList.innerHTML = listHtml;
  }

  ownerFilter.addEventListener("input", applyFiltersAndRender);
  activeOnlyChk.addEventListener("change", applyFiltersAndRender);
  ownerFilterList.addEventListener("input", applyFiltersAndRender);
  activeOnlyList.addEventListener("change", applyFiltersAndRender);

  // --- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î 50) ---
  const tablesQuery = query(
    collection(db,"tables"),
    orderBy("lastActivity","desc"),
    limit(50)
  );

  onSnapshot(tablesQuery, (snap)=>{
    tablesArray = [];
    tablesCache = {};

    if(snap.empty){
      tableList.innerHTML = `<div class="muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏ï‡πä‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏•‡∏¢</div>`;
      tableSelect.innerHTML = `<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ï‡πä‡∏∞ ‚Äî</option>`;
      return;
    }

    const now = Date.now();

    snap.forEach(docSnap=>{
      const id   = docSnap.id;
      const data = docSnap.data();
      tablesCache[id] = data;

      let lastStr = "‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡πÄ‡∏ß‡∏•‡∏≤";
      let lastMs  = 0;

      if(data.lastActivity && data.lastActivity.toDate){
        const d = data.lastActivity.toDate();
        lastStr = d.toLocaleString("th-TH");
        lastMs  = d.getTime();
      }

      const rounds  = data.totalRounds || 0;
      const status  = data.status || "unknown";
      const isRecent   = lastMs && ((now - lastMs) < 15*60*1000);
      const owner      = data.ownerEmail || data.ownerUid || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏";
      const hasOverride= data.tableWeights && data.tableUseGlobal === false;
      const configLabel= hasOverride ? "üéØ override" : "‚Ü© global";

      tablesArray.push({
        id,
        data,
        lastStr,
        lastMs,
        isRecent,
        rounds,
        status,
        owner,
        hasOverride,
        configLabel
      });
    });

    applyFiltersAndRender();
  }, (err)=>{
    console.error("tables snapshot error:", err);
    tableList.innerHTML = `<div class="warn">‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏ï‡πä‡∏∞‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${err.message}</div>`;
  });

</script>
</body>
</html>
